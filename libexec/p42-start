#!/usr/bin/env bash

# Usage: p42 start [<component>]
# Summary: Start application component.
# Help: Start application component.
# You can start component for the entire application
# or just a given set of components. Images for each
# container must already exist.
#
#     p42 start
#     p42 start www redis
#
# You can build images first using the build subcommand.
# The run subcommand will build and start component for you.
#

if [ ! -e ./p42.yaml ]; then
  echo p42: missing p42.yaml file
  echo p42: try running: p42 init
  exit -1
fi

name=$(yaml get ./p42.yaml name)
repo=$(yaml get ./p42.yaml repo)

if [ $# -gt 0 ]; then
  component="$@"
else
  if [ ! -d ./launch ]; then
    echo p42: nothing to start
    exit
  fi
  component=$(ls ./launch)
fi

# TODO: what if the swarm master dies?
eval $(docker-machine env --swarm swarm-00)

for container in $component; do
  label=$name-$container
  echo Starting $label container...
  # TODO: add error handling for Docker errors?
  # TODO: components that launch multiple containers?
  # TODO: specifying constraints for Swarm deploy?
  docker run \
    -P \
    --name ${label} \
    --restart always \
    -d ${repo}/${label}:latest
done
