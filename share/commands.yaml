aws:

  cloudformation:

    create-stack:
      template: |
        aws cloudformation create-stack
          --stack-name {{name}}
          --template-body file://{{file}}

      response:
        use: silent

    describe-stacks:

      template: |
        aws cloudformation describe-stacks --stack-name {{name}}

      response:

        use: json
        attributes:
          - name: status
            accessor: json Stacks[0].StackStatus
            test: CREATE_COMPLETE
          - name: vpc
            accessor: Stacks[0].Outputs[0].OutputValue
            test: test-vpc-00
          - name: subnet
            accessor: Stacks[0].Outputs[1].OutputValue
            test: test-subnet-00
          - name: az
            accessor: Stacks[0].Outputs[2].OutputValue
            test: us-west-1a
          - name: dns
            accessor: Stacks[0].Outputs[3].OutputValue
            test: test-dns-00

    delete-stack:

      template: |
        aws cloudformation delete-stack --stack-name {{name}}

      response:
        use: silent

  elb:

    describe-load-balancers:

      template: |
        aws elb describe-load-balancers
          --load-balancer-name {{cluster}}

      response:
        use: json
        attributes:
          - name: elb_zone_id
            accessor: LoadBalancerDescriptions[0].CanonicalHostedZoneNameID
          - name: elb_domain
            accessor: LoadBalancerDescriptions[0].CanonicalHostedZoneName

    register-instances-with-load-balancer:

      template: |
        aws elb register-instances-with-load-balancer
            --load-balancer-name {{cluster}}
            --instances {{instance_id}}

      response:
        use: silent

  ecr:

    create-repository:

      template: |
        aws ecr create-repository
          --repository-name {{name}}
          --region us-east-1

    set-repository-policy:

      template: |
        aws ecr set-repository-policy
          --repository-name {{name}}
          --region us-east-1
          --policy-text {{policy}}


    describe-repositories:

      template: |
        aws ecr describe-repositories
          --repository-name {{name}}
          --region us-east-1
      response:
        use: json
        attributes:
          - name: repository_id
            accessor: repositories[0].registryId

    # actually used to get the registry URL
    get-authorization-token:
      template: |
        aws ecr get-authorization-token
          --region us-east-1

      response:
        use: json
        attributes:
          - name: url
            accessor: json authorizationData[0].proxyEndpoint
            test: 'https://123.registry.test.com'

  ec2:

    describe-instances:

      template: |
        aws ec2 describe-instances
          --filters Name=tag-value,Values={{name}}

      response:
        use: json
        attributes:
          - name: instance_id
            accessor: Reservations[0].Instances[0].InstanceId
            test: test-instance-00
          - name: instance_ip
            accessor: Reservations[0].Instances[0].PrivateIpAddress
            test: test-instance-00

    describe-security-groups:

      template: |
        aws ec2 describe-security-groups
          --filters
            Name=vpc-id,Values={{vpc}}
            Name=group-name,Values={{name}}

      response:
        use: json
        attributes:
          - name: group_id
            accessor: SecurityGroups[0].GroupId
            test: test-sg-00


    modify-instance-attribute:

      template: |
        aws ec2 modify-instance-attribute
          --instance-id {{instance_id}}
          --groups {{group_ids}}
      response:
        use: silent

  route53:

    list-hosted-zones-by-name:

      template: |
        aws route53 list-hosted-zones-by-name
          --dns-name {{domain}}
          --max-items 1

      response:
        use: json
        attributes:
          - name: domain_zone_id
            accessor: HostedZones[0].Id)
            test: test-dns-00

    change-resource-record-sets:

      template: |
        aws route53 change-resource-record-sets
          --hosted-zone-id {{zone_id}}
          --change-batch file://{{file}}

      response:
        use: silent
